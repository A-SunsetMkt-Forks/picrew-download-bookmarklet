<!doctype html><html lang=en><meta charset=utf-8>
<title>Picrew downloader bookmarklet</title>
<main>
<h1>Picrew downloader bookmarklet</h1>
<p>These are JavaScript bookmarklets. Save them in your browser's bookmarks.
Then run the bookmarklet on a <i>picrew.me/image_maker</i> or <i>picrew.me/secret_image_maker</i>.</p>
<a href="javascript:if(location.hostname!='picrew.me'||!(location.pathname.startsWith('/image_maker/')||location.pathname.startsWith('/secret_image_maker/')))alert('Not a Picrew image maker!');else void(async()=>{let L=[],D=[],M=0,E=0,F=0;const b=document.createElement('progress'),C=(()=>{for(var a,o=[],c=0;c<256;c++){a=c;for(let f=0;f<8;f++)a=1&a?3988292384^a>>>1:a>>>1;o[c]=a}return o})(),c=b=>{for(var r=new Int8Array(b),n=-1,t=0;t<r.length;t++)n=n>>>8^C[255&(n^r[t])];return~n},N=window.__NUXT__.state,U=s=>new TextEncoder().encode(s),a=(p,d='')=>{const q=new DataView(new ArrayBuffer(26)),r=U(p),s=new DataView(new ArrayBuffer(14));q.setInt32(0,(d?10:20)+(1<<27),1);q.setInt32(10,c(d),1);for(const i of [14,18])q.setInt32(i,d.byteLength,1);q.setInt16(22,r.length,1);L.push('PK\u0003\u0004',q,r,d);s.setInt32(10,M,1);D.push('PK\u0001\u0002\u0014\u0000',q,s,r);M+=30+r.length+(d.byteLength|0);E+=46+r.length;F++};b.style.position='absolute';b.style.top=0;b.style.width='100%';document.body.appendChild(b);a('mimetype',U('image/openraster'));a('data/');a('Thumbnails/');a('comment.txt',U(N.imageMakerInfo.description));const R=document.getElementById('my-canvas-object').firstElementChild.firstElementChild,S=256/Math.max(N.config.w,N.config.h),T=document.createElement('canvas'),V=N.config.h*S|0,W=N.config.w*S|0,X=document.implementation.createDocument(null,'image'),Y=X.documentElement,Z=X.createElement('stack'),l=JSON.parse(localStorage['picrew.local.data.'+N.imageMakerId]),A=new DataView(new ArrayBuffer(18));await fetch(R.toDataURL()).then(r=>r.arrayBuffer()).then(x=>a('mergedimage.png',x));T.width=W;T.height=V;T.getContext('2d').drawImage(R,0,0,W,V);await fetch(T.toDataURL()).then(r=>r.arrayBuffer()).then(x=>a('Thumbnails/thumbnail.png',x));Y.setAttribute('w',N.config.w);Y.setAttribute('h',N.config.h);Y.setAttribute('version','0.0.3');Y.appendChild(Z);b.max=Object.values(l).filter(x=>x.itmId).length;b.value=0;for(const d of Object.entries(N.config.lyrList).sort((a,b)=>b[1]-a[1])){const e=N.config.pList.find(p=>p.lyrs.includes(d[0]|0)),m=l[e.pId];if(N.commonImages[m.itmId]&&N.commonImages[m.itmId][d[0]]&&N.commonImages[m.itmId][d[0]][m.cId]){const o=X.createElement('layer'),n=N.commonImages[m.itmId][d[0]][m.cId].url,p='data/'+n.split('/').pop();o.setAttribute('src',p);o.setAttribute('name',e.pNm);o.setAttribute('x',m.xCnt+e.x);o.setAttribute('y',m.yCnt+e.y);Z.appendChild(o);await fetch(n).then(r=>r.arrayBuffer()).then(x=>a(p,x));b.value++}}a('stack.xml',U(new XMLSerializer().serializeToString(X)));for(const i of [4,6])A.setInt16(i,F,1);A.setInt32(8,E,1);A.setInt32(12,M,1);D.push('PK\u0005\u0006',A);const B=URL.createObjectURL(new Blob(L.concat(D),{type:'application/zip'})),h=document.createElement('a');h.href=B;h.download=N.imageMakerId +'.ora';h.click();URL.revokeObjectURL(B);document.body.removeChild(b)})().catch(alert)//1.0">Download current Picrew state bookmarklet</a><br>
<a href="javascript:if(location.hostname!='picrew.me'||!(location.pathname.startsWith('/image_maker/')||location.pathname.startsWith('/secret_image_maker/')))alert('Not a Picrew image maker!');else void(async()=>{let L=[],D=[],M=0,E=0,F=0;const b=document.createElement('progress'),C=(()=>{for(var a,o=[],c=0;c<256;c++){a=c;for(let f=0;f<8;f++)a=1&a?3988292384^a>>>1:a>>>1;o[c]=a}return o})(),c=b=>{for(var r=new Int8Array(b),n=-1,t=0;t<r.length;t++)n=n>>>8^C[255&(n^r[t])];return~n},N=window.__NUXT__.state,U=s=>new TextEncoder().encode(s),a=(p,d='')=>{const q=new DataView(new ArrayBuffer(26)),r=U(p),s=new DataView(new ArrayBuffer(14));q.setInt32(0,(d?10:20)+(1<<27),1);q.setInt32(10,c(d),1);for(const i of [14,18])q.setInt32(i,d.byteLength,1);q.setInt16(22,r.length,1);L.push('PK\u0003\u0004',q,r,d);s.setInt32(10,M,1);D.push('PK\u0001\u0002\u0014\u0000',q,s,r);M+=30+r.length+(d.byteLength|0);E+=46+r.length;F++};b.style.position='absolute';b.style.top=0;b.style.width='100%';document.body.appendChild(b);a('mimetype',U('image/openraster'));a('data/');a('Thumbnails/');a('comment.txt',U(N.imageMakerInfo.description));const R=document.getElementById('my-canvas-object').firstElementChild.firstElementChild,S=256/Math.max(N.config.w,N.config.h),T=document.createElement('canvas'),V=N.config.h*S|0,W=N.config.w*S|0,X=document.implementation.createDocument(null,'image'),Y=X.documentElement,Z=X.createElement('stack'),l=JSON.parse(localStorage['picrew.local.data.'+N.imageMakerId]),A=new DataView(new ArrayBuffer(18));await fetch(R.toDataURL()).then(r=>r.arrayBuffer()).then(x=>a('mergedimage.png',x));T.width=W;T.height=V;T.getContext('2d').drawImage(R,0,0,W,V);await fetch(T.toDataURL()).then(r=>r.arrayBuffer()).then(x=>a('Thumbnails/thumbnail.png',x));Y.setAttribute('w',N.config.w);Y.setAttribute('h',N.config.h);Y.setAttribute('version','0.0.3');Y.appendChild(Z);b.max=0;for(const n of Object.values(N.commonImages))for(const d of Object.values(n))b.max+=Object.keys(d).length;b.value=0;for(const d of Object.entries(N.config.lyrList).sort((a,b)=>b[1]-a[1])){const e=N.config.pList.find(p=>p.lyrs.includes(d[0]|0)),g='data/'+d[1]+'/',p=X.createElement('stack');a(g);Z.appendChild(p);p.setAttribute('x',e.x);p.setAttribute('y',e.y);p.setAttribute('name',e.pNm);for(const n of e.items)for(const O of N.config.cpList[e.cpId])if(N.commonImages[n.itmId]&&N.commonImages[n.itmId][d[0]]&&N.commonImages[n.itmId][d[0]][O.cId]){const o=X.createElement('layer'),G=g+n.itmId+O.cd+'.png',m=l[e.pId];p.appendChild(o);o.setAttribute('src',G);if(m.itmId==n.itmId&&m.cId==O.cId){o.setAttribute('x',m.xCnt);o.setAttribute('y',m.yCnt)}else o.setAttribute('visibility','hidden');await fetch(N.commonImages[n.itmId][d[0]][O.cId].url).then(r=>r.arrayBuffer()).then(x=>a(G,x));b.value++}}a('stack.xml',U(new XMLSerializer().serializeToString(X)));for(const i of [4,6])A.setInt16(i,F,1);A.setInt32(8,E,1);A.setInt32(12,M,1);D.push('PK\u0005\u0006',A);const B=URL.createObjectURL(new Blob(L.concat(D),{type:'application/zip'})),h=document.createElement('a');h.href=B;h.download=N.imageMakerId +'.ora';h.click();URL.revokeObjectURL(B);document.body.removeChild(b)})().catch(alert)//1.0">Download entire Picrew maker bookmarklet</a>
<p>It is known the maximum file size my code can correctly generate is around 4 gibibytes, due to the structure of the ZIP format. I deem this to not be a problem.
<h2>What?</h2>
<p><a href=https://picrew.me>Picrew</a> is a popular platform for image makers: multi-layer images designed to be customizable.<br>
These bookmarklets save Picrew image makers in the OpenRaster format, a cross-application layered image format. OpenRaster files can also be opened as ZIP archives.<br>
The generated OpenRaster files deviate from the specification thusly: They contain a <code>comment.txt</code>. I set <code>comment.txt</code> to the image makers' provided descriptions.
<h2>Didn't you already make this?</h2>
<p>Previously, I had created the Picrew downloader browser extension. The bookmarklet has such improvements as:
<ul>
<li>Displaying a nifty progress bar
<li>Being an order of magnitude smaller (most of the original's size came from JSZip, of which I was not using most features)
<li>Not needing me to go through manifest-upgrading or polyglotting or extension-store shenanigans
</ul>
<h2>Can I see the source code instead of the minified version?</h2>
<p>Yep! Here's <a href=picrew-downloader.js>the source code</a>
<h2>What's the license?</h2>
<p>uhh "you can do whatever you want with this code" ok bye
</main>
<footer><a href=https://mincerafter42.github.io>Return to Viatrix's home page</a> <a href=https://github.com/mincerafter42/picrew-download-bookmarklet/>View on GitHub</a></footer>
